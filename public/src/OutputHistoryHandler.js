document.addEventListener('DOMContentLoaded', function() {
    displayHistory();
});

function displayHistory() {
    const historyContainer = document.getElementById('historyContainer');
    const outputHistory = JSON.parse(localStorage.getItem('outputHistory')) || [];

    historyContainer.innerHTML = '';

    outputHistory.forEach((entry, index) => {
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('history-entry');

        const titleDiv = document.createElement('div');
        titleDiv.textContent = `Response #${index + 1} - Generated by: ${entry.formId}`;

        const timestampDiv = document.createElement('div');
        timestampDiv.textContent = `Created at: ${new Date(entry.timestamp).toLocaleString()}`;

        const contentPreview = document.createElement('p');
        contentPreview.textContent = entry.response.slice(0, 150) + '...'; // Preview of the content

        const expandButton = document.createElement('button');
        expandButton.textContent = 'Expand';
        expandButton.addEventListener('click', function() {
            const modal = document.getElementById(`modal-${index}`);
            modal.style.display = 'block';
        });

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this entry?')) {
                outputHistory.splice(index, 1);
                localStorage.setItem('outputHistory', JSON.stringify(outputHistory));
                displayHistory();
            }
        });

        const copyButton = document.createElement('button');
        copyButton.textContent = 'Copy';
        copyButton.addEventListener('click', function() {
            navigator.clipboard.writeText(entry.response).then(() => {
                alert('Text copied to clipboard');
            }, () => {
                alert('Failed to copy text');
            });
        });

        const printButton = document.createElement('button');
        printButton.textContent = 'Print';
        printButton.addEventListener('click', function() {
            printText(entry.response);
        });

        entryDiv.appendChild(titleDiv);
        entryDiv.appendChild(timestampDiv);
        entryDiv.appendChild(contentPreview);
        entryDiv.appendChild(expandButton);
        entryDiv.appendChild(copyButton);
        //entryDiv.appendChild(printButton);
        entryDiv.appendChild(deleteButton);

        const modal = createModal(entry.response, index);
        document.body.appendChild(modal);

        historyContainer.appendChild(entryDiv);
    });
}

function createModal(content, index) {
    const modal = document.createElement('div');
    modal.classList.add('modal');
    modal.id = `modal-${index}`;

    const modalContent = document.createElement('div');
    modalContent.classList.add('modal-content');

    const closeModal = document.createElement('span');
    closeModal.textContent = 'Ã—';
    closeModal.classList.add('close');
    closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    const contentText = document.createElement('div');
    contentText.classList.add('content-text');
    contentText.innerHTML = content.replace(/\n/g, '<br>');

    modalContent.appendChild(closeModal);
    modalContent.appendChild(contentText);
    modal.appendChild(modalContent);

    return modal;
}

function printText(textToPrint) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>Print</title></head><body>${textToPrint.replace(/\n/g, '<br>')}</body></html>`);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
